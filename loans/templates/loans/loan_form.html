{% extends 'loans/base.html' %}

{% block title %}{{ action }} Loan - Credit Approval System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-money-bill-wave me-2"></i>
                {{ action }} Loan
            </h1>
            <a href="{% url 'loans:loan_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Back to List
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    Loan Information
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" id="loanForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="customer_id" class="form-label">
                                <i class="fas fa-user me-1"></i>
                                Customer *
                            </label>
                            <select class="form-control" id="customer_id" name="customer_id" required>
                                <option value="">Select a customer...</option>
                                {% for customer in customers %}
                                    <option value="{{ customer.customer_id }}" 
                                            {% if loan.customer.customer_id == customer.customer_id %}selected{% endif %}>
                                        {{ customer.first_name }} {{ customer.last_name }} (ID: {{ customer.customer_id }})
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose the customer for this loan</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="loan_amount" class="form-label">
                                <i class="fas fa-dollar-sign me-1"></i>
                                Loan Amount *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="loan_amount" name="loan_amount" 
                                       value="{{ loan.loan_amount|default:'' }}" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-text">Enter the loan amount</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tenure" class="form-label">
                                <i class="fas fa-calendar me-1"></i>
                                Tenure (months) *
                            </label>
                            <input type="number" class="form-control" id="tenure" name="tenure" 
                                   value="{{ loan.tenure|default:'' }}" min="1" max="360" required>
                            <div class="form-text">Loan duration in months (1-360)</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="interest_rate" class="form-label">
                                <i class="fas fa-percentage me-1"></i>
                                Interest Rate (%) *
                            </label>
                            <input type="number" class="form-control" id="interest_rate" name="interest_rate" 
                                   value="{{ loan.interest_rate|default:'' }}" step="0.01" min="0.01" max="100" required>
                            <div class="form-text">Annual interest rate percentage</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="monthly_repayment" class="form-label">
                                <i class="fas fa-credit-card me-1"></i>
                                Monthly Repayment *
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="monthly_repayment" name="monthly_repayment" 
                                       value="{{ loan.monthly_repayment|default:'' }}" step="0.01" min="0.01" required>
                            </div>
                            <div class="form-text">Monthly payment amount</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="emis_paid_on_time" class="form-label">
                                <i class="fas fa-check-circle me-1"></i>
                                EMIs Paid on Time
                            </label>
                            <input type="number" class="form-control" id="emis_paid_on_time" name="emis_paid_on_time" 
                                   value="{{ loan.emis_paid_on_time|default:'0' }}" min="0" required>
                            <div class="form-text">Number of EMIs paid on time</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">
                                <i class="fas fa-play me-1"></i>
                                Start Date *
                            </label>
                            <input type="date" class="form-control" id="start_date" name="start_date" 
                                   value="{{ loan.start_date|date:'Y-m-d'|default:'' }}" required>
                            <div class="form-text">Loan start date</div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="end_date" class="form-label">
                                <i class="fas fa-stop me-1"></i>
                                End Date *
                            </label>
                            <input type="date" class="form-control" id="end_date" name="end_date" 
                                   value="{{ loan.end_date|date:'Y-m-d'|default:'' }}" required>
                            <div class="form-text">Expected loan end date</div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'loans:loan_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>
                            {{ action }} Loan
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Form validation
    $('#loanForm').on('submit', function(e) {
        let isValid = true;
        
        // Clear previous error states
        $('.form-control').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        // Validate required fields
        $('input[required], select[required]').each(function() {
            if (!$(this).val().trim()) {
                $(this).addClass('is-invalid');
                $(this).after('<div class="invalid-feedback">This field is required.</div>');
                isValid = false;
            }
        });
        
        // Validate loan amount
        const loanAmount = parseFloat($('#loan_amount').val());
        if (loanAmount <= 0) {
            $('#loan_amount').addClass('is-invalid');
            $('#loan_amount').after('<div class="invalid-feedback">Loan amount must be greater than 0.</div>');
            isValid = false;
        }
        
        // Validate tenure
        const tenure = parseInt($('#tenure').val());
        if (tenure < 1 || tenure > 360) {
            $('#tenure').addClass('is-invalid');
            $('#tenure').after('<div class="invalid-feedback">Tenure must be between 1 and 360 months.</div>');
            isValid = false;
        }
        
        // Validate interest rate
        const interestRate = parseFloat($('#interest_rate').val());
        if (interestRate <= 0 || interestRate > 100) {
            $('#interest_rate').addClass('is-invalid');
            $('#interest_rate').after('<div class="invalid-feedback">Interest rate must be between 0.01% and 100%.</div>');
            isValid = false;
        }
        
        // Validate monthly repayment
        const monthlyRepayment = parseFloat($('#monthly_repayment').val());
        if (monthlyRepayment <= 0) {
            $('#monthly_repayment').addClass('is-invalid');
            $('#monthly_repayment').after('<div class="invalid-feedback">Monthly repayment must be greater than 0.</div>');
            isValid = false;
        }
        
        // Validate EMIs paid
        const emisPaid = parseInt($('#emis_paid_on_time').val() || 0);
        if (emisPaid < 0 || emisPaid > tenure) {
            $('#emis_paid_on_time').addClass('is-invalid');
            $('#emis_paid_on_time').after('<div class="invalid-feedback">EMIs paid cannot exceed tenure.</div>');
            isValid = false;
        }
        
        // Validate dates
        const startDate = new Date($('#start_date').val());
        const endDate = new Date($('#end_date').val());
        
        if (startDate >= endDate) {
            $('#end_date').addClass('is-invalid');
            $('#end_date').after('<div class="invalid-feedback">End date must be after start date.</div>');
            isValid = false;
        }
        
        if (!isValid) {
            e.preventDefault();
            $('html, body').animate({
                scrollTop: $('.is-invalid').first().offset().top - 100
            }, 500);
        }
    });
    
    // Real-time validation feedback
    $('.form-control').on('blur', function() {
        const $input = $(this);
        const value = $input.val().trim();
        
        if ($input.attr('required') && !value) {
            $input.addClass('is-invalid');
            if (!$input.next('.invalid-feedback').length) {
                $input.after('<div class="invalid-feedback">This field is required.</div>');
            }
        } else {
            $input.removeClass('is-invalid');
            $input.next('.invalid-feedback').remove();
        }
    });
    
    // Auto-calculate end date based on start date and tenure
    $('#start_date, #tenure').on('change', function() {
        const startDate = $('#start_date').val();
        const tenure = parseInt($('#tenure').val());
        
        if (startDate && tenure) {
            const start = new Date(startDate);
            const end = new Date(start);
            end.setMonth(end.getMonth() + tenure);
            
            $('#end_date').val(end.toISOString().split('T')[0]);
        }
    });
    
    // Auto-calculate monthly repayment (simple calculation)
    $('#loan_amount, #interest_rate, #tenure').on('change', function() {
        const loanAmount = parseFloat($('#loan_amount').val());
        const interestRate = parseFloat($('#interest_rate').val());
        const tenure = parseInt($('#tenure').val());
        
        if (loanAmount && interestRate && tenure) {
            const monthlyRate = interestRate / 100 / 12;
            const monthlyPayment = (loanAmount * monthlyRate * Math.pow(1 + monthlyRate, tenure)) / 
                                  (Math.pow(1 + monthlyRate, tenure) - 1);
            
            if (!isNaN(monthlyPayment) && isFinite(monthlyPayment)) {
                $('#monthly_repayment').val(monthlyPayment.toFixed(2));
            }
        }
    });
});
</script>
{% endblock %} 